<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evercall - TTS Terminal</title>

    <!-- åŠ è½½Live2D Cubism Core SDK -->
    <script src="/static/live2dcubismcore.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* ç²’å­æ•ˆæœCanvas */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999; /* æé«˜z-indexç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            pointer-events: none;
            background: transparent;
        }

        /* èƒŒæ™¯åŠ¨ç”»ç½‘æ ¼ */
        .grid-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(0, 162, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 162, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* ä¸»å®¹å™¨ */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            min-height: 100vh;
        }

        /* å·¦ä¾§ä¸»é¢æ¿ */
        .main-panel {
            background: linear-gradient(145deg, rgba(16, 16, 16, 0.95), rgba(32, 32, 32, 0.95));
            border: 2px solid #00a2ff;
            border-radius: 0;
            position: relative;
            padding: 2rem;
            box-shadow:
                0 0 30px rgba(0, 162, 255, 0.3),
                inset 0 0 50px rgba(0, 162, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        /* Live2Dæ¨¡å‹å®¹å™¨æ ·å¼ */
        .live2d-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            background: rgba(16, 16, 16, 0.95);
            border: 2px solid #00a2ff;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 162, 255, 0.3);
        }

        #live2d-canvas {
            width: 100%;
            height: 100%;
            border-radius: 15px;
        }

        .live2d-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .live2d-btn {
            padding: 4px 8px;
            background: rgba(0, 162, 255, 0.2);
            border: 1px solid rgba(0, 162, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .live2d-btn:hover {
            background: rgba(0, 162, 255, 0.4);
            transform: scale(1.05);
        }

        /* è£…é¥°æ€§è¾¹è§’ */
        .main-panel::before,
        .main-panel::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #ff6600;
        }

        .main-panel::before {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .main-panel::after {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        /* æ ‡é¢˜ */
        .title {
            font-family: 'Orbitron', monospace;
            font-size: 2.5rem;
            font-weight: 900;
            color: #00a2ff;
            text-align: center;
            margin-bottom: 2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(0, 162, 255, 0.5);
            position: relative;
        }

        .title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #ff6600, transparent);
        }

        .subtitle {
            text-align: center;
            color: #ff6600;
            font-size: 1.1rem;
            margin-bottom: 2rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #333;
            border-radius: 0;
            padding: 1rem;
            margin-bottom: 2rem;
            position: relative;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .status::before {
            content: 'â– ';
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .status.disconnected {
            border-left: 4px solid #ff4757;
            color: #ff4757;
        }

        .status.disconnected::before {
            color: #ff4757;
            animation: pulse 2s infinite;
        }

        .status.connected {
            border-left: 4px solid #2ed573;
            color: #2ed573;
        }

        .status.connected::before {
            color: #2ed573;
        }

        .status.processing {
            border-left: 4px solid #ff6600;
            color: #ff6600;
        }

        .status.processing::before {
            color: #ff6600;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            margin-bottom: 2rem;
        }

        .input-label {
            display: block;
            margin-bottom: 1rem;
            color: #00a2ff;
            font-size: 1.1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .input-label::before {
            content: 'â–¶';
            margin-right: 8px;
            color: #ff6600;
        }

        .text-input {
            width: 100%;
            min-height: 120px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #333;
            color: #ffffff;
            font-size: 1rem;
            font-family: 'Rajdhani', sans-serif;
            padding: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #00a2ff;
            box-shadow:
                0 0 20px rgba(0, 162, 255, 0.3),
                inset 0 0 20px rgba(0, 162, 255, 0.1);
        }

        /* æŒ‰é’® */
        .action-btn {
            width: 100%;
            padding: 1.2rem 2rem;
            background: linear-gradient(45deg, #ff6600, #ff8533);
            border: none;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .action-btn:hover {
            background: linear-gradient(45deg, #ff8533, #ffaa66);
            box-shadow: 0 0 30px rgba(255, 102, 0, 0.5);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        /* è¿›åº¦ä¿¡æ¯ */
        .progress-panel {
            background: rgba(0, 162, 255, 0.1);
            border: 1px solid #00a2ff;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .progress-panel::before {
            content: 'PROGRESS';
            position: absolute;
            top: -12px;
            left: 15px;
            background: #0a0a0a;
            padding: 0 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: #00a2ff;
            font-weight: 700;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-family: 'Orbitron', monospace;
        }

        .progress-label {
            color: #ccc;
        }

        .progress-value {
            color: #00a2ff;
            font-weight: 700;
        }

        /* éŸ³é¢‘æ§åˆ¶ */
        .audio-section {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .audio-player {
            width: 100%;
            margin: 1rem 0;
            background: #000;
        }

        /* å³ä¾§ä¿¡æ¯é¢æ¿ */
        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Live2D è§’è‰²é¢æ¿ */
        .live2d-panel {
            background: linear-gradient(145deg, rgba(16, 16, 16, 0.95), rgba(32, 32, 32, 0.95));
            border: 2px solid #00ff88;
            padding: 1.5rem;
            position: relative;
            backdrop-filter: blur(10px);
            height: 350px;
            border-radius: 10px;
            overflow: hidden;
        }

        .live2d-panel::before {
            content: 'DIGITAL ASSISTANT';
            position: absolute;
            top: -12px;
            left: 15px;
            background: #0a0a0a;
            padding: 0 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: #00ff88;
            font-weight: 700;
            z-index: 10;
        }

        .live2d-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .live2d-canvas {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 255, 136, 0.1) 0%, rgba(0, 162, 255, 0.05) 100%);
        }

        .live2d-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff88;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            text-align: center;
            z-index: 5;
        }

        .live2d-controls {
            position: absolute;
            top: 25px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .live2d-btn {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
        }

        .live2d-btn:hover {
            background: rgba(0, 255, 136, 0.4);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        /* Live2Dç‰¹æ•ˆ */
        @keyframes live2dGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 255, 136, 0.6); }
        }

        .live2d-panel.active {
            animation: live2dGlow 2s infinite;
        }

        /* éŸ³é¢‘ç¼“å­˜é¢æ¿ */
        .cache-panel {
            background: linear-gradient(145deg, rgba(16, 16, 16, 0.95), rgba(32, 32, 32, 0.95));
            border: 2px solid #ff6600;
            padding: 1.5rem;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .cache-panel::before {
            content: 'AUDIO CACHE';
            position: absolute;
            top: -12px;
            left: 15px;
            background: #0a0a0a;
            padding: 0 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: #ff6600;
            font-weight: 700;
        }

        .cache-title {
            color: #ff6600;
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .cache-list {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #00a2ff #333;
        }

        .cache-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            margin-bottom: 0.5rem;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .cache-item:hover {
            border-color: #00a2ff;
            box-shadow: 0 0 15px rgba(0, 162, 255, 0.3);
        }

        .cache-item.playing {
            border-color: #ff6600;
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.3);
        }

        .cache-text {
            color: #ccc;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cache-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            font-family: 'Orbitron', monospace;
        }

        .cache-key {
            background: #00a2ff;
            color: #000;
            padding: 2px 8px;
            font-weight: 700;
            min-width: 25px;
            text-align: center;
        }

        .cache-meta {
            color: #666;
        }

        .delete-btn {
            background: #ff4757;
            border: none;
            color: white;
            padding: 4px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #ff3838;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        /* æ—¥å¿—é¢æ¿ */
        .log-panel {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #333;
            height: 250px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Orbitron', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .log-panel::before {
            content: 'SYSTEM LOG';
            position: absolute;
            top: -12px;
            left: 15px;
            background: #0a0a0a;
            padding: 0 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: #00a2ff;
            font-weight: 700;
        }

        .log-entry {
            margin-bottom: 0.3rem;
            padding: 0.2rem 0;
        }

        .log-entry.error {
            color: #ff4757;
        }

        .log-entry.success {
            color: #2ed573;
        }

        .log-entry.info {
            color: #00a2ff;
        }

        .log-timestamp {
            color: #666;
            margin-right: 0.5rem;
        }

        /* å¿«æ·é”®æç¤º */
        .hotkey-info {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid #ff6600;
            padding: 1rem;
            font-size: 0.85rem;
            text-align: center;
        }

        .hotkey-info::before {
            content: 'HOTKEYS';
            position: absolute;
            top: -12px;
            left: 15px;
            background: #0a0a0a;
            padding: 0 10px;
            font-family: 'Orbitron', monospace;
            font-size: 0.8rem;
            color: #ff6600;
            font-weight: 700;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .title {
                font-size: 1.8rem;
            }

            .main-panel,
            .cache-panel,
            .live2d-panel {
                padding: 1rem;
            }

            .live2d-panel {
                height: 250px;
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #00a2ff;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff6600;
        }

        /* åŠ è½½åŠ¨ç”» */
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 162, 255, 0.3); }
            50% { box-shadow: 0 0 40px rgba(0, 162, 255, 0.6); }
        }

        .processing .main-panel {
            animation: glow 2s infinite;
        }
    </style>
</head>
<body>
    <canvas id="particleCanvas"></canvas>
    <div class="grid-background"></div>

    <!-- Live2Dæ¨¡å‹å®¹å™¨ -->
    <div class="live2d-container">
        <canvas id="live2d-canvas"></canvas>
        <div class="live2d-controls">
            <button class="live2d-btn" onclick="changeExpression('ku')">å“­</button>
            <button class="live2d-btn" onclick="changeExpression('lianhong')">è„¸çº¢</button>
            <button class="live2d-btn" onclick="changeExpression('shoubiao')">æ‰‹è¡¨</button>
            <button class="live2d-btn" onclick="changeExpression('quanquan')">åœˆåœˆ</button>
            <button class="live2d-btn" onclick="changeExpression('dayouxi')">æ‰“æ¸¸æˆ</button>
            <button class="live2d-btn" onclick="changeExpression('changge')">å”±æ­Œ</button>
            <button class="live2d-btn" onclick="changeExpression('bangbangtang')">æ£’æ£’ç³–</button>
            <button class="live2d-btn" onclick="changeExpression('heiyi')">é»‘è¡£</button>
            <button class="live2d-btn" onclick="changeExpression('shengqi')">ç”Ÿæ°”</button>
            <button class="live2d-btn" onclick="changeExpression('heilian')">é»‘è„¸</button>
            <button class="live2d-btn" onclick="changeExpression('xingxing')">æ˜Ÿæ˜Ÿ</button>
        </div>
    </div>

    <div class="container">
        <div class="main-panel">
            <h1 class="title">Evercall</h1>
            <div class="subtitle">TTS Terminal System</div>

            <div id="status" class="status disconnected">
                System Offline
            </div>

            <div class="input-section">
                <label class="input-label" for="textInput">Text Input Protocol</label>
                <textarea
                    id="textInput"
                    class="text-input"
                    placeholder="è¯·è¾“å…¥è¦è½¬æ¢ä¸ºè¯­éŸ³çš„æ–‡æœ¬..."
                    maxlength="5000"
                                 >ä½ å¥½ï¼Œè¿™æ˜¯Evercallè¯­éŸ³åˆæˆç³»ç»Ÿã€‚æˆ‘å¯ä»¥å°†è¿™æ®µæ–‡æœ¬è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„ä¸­æ–‡è¯­éŸ³ã€‚</textarea>
            </div>

            <button id="synthesizeBtn" class="action-btn">
                Initialize Synthesis
            </button>

            <div id="progressInfo" class="progress-panel" style="display: none;">
                <div class="progress-item">
                    <span class="progress-label">Status:</span>
                    <span class="progress-value" id="synthStatus">Standby</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Audio Chunks:</span>
                    <span class="progress-value" id="chunkCount">0</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Data Size:</span>
                    <span class="progress-value" id="audioSize">0 bytes</span>
                </div>
            </div>

            <div class="audio-section">
                <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                </audio>
            </div>
        </div>

        <div class="info-panel">
            <!-- Live2D è§’è‰²æ˜¾ç¤ºé¢æ¿ -->
            <div id="live2dPanel" class="live2d-panel">
                <div class="live2d-controls">
                    <button class="live2d-btn" onclick="loadLive2DModel()">LOAD</button>
                    <button class="live2d-btn" onclick="resetLive2DModel()">RESET</button>
                    <button class="live2d-btn" onclick="toggleExpression()">EXPR</button>
                </div>
                <div id="live2dContainer" class="live2d-container">
                    <div class="live2d-canvas" id="live2dCanvas">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #00ff88; font-family: 'Orbitron', monospace; text-align: center;">
                            <div>
                                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ­</div>
                                <div>LANHEI MODEL</div>
                                <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Click LOAD to initialize</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="live2dStatus" class="live2d-status">
                    Standby - Waiting for initialization
                </div>
            </div>

            <div id="audioCache" class="cache-panel" style="display: none;">
                <h3 class="cache-title">Audio Archive</h3>
                <div id="cacheList" class="cache-list"></div>
                <div class="hotkey-info">
                    <small>Press 1-9, 0 for quick playback</small>
                </div>
            </div>

            <div class="log-panel">
                <div id="logs">
                    <div class="log-entry info">
                        <span class="log-timestamp">[INIT]</span>
                        System initialization in progress...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.2.4/dist/pixi.min.js"></script>
    <script>
        // Live2Dç›¸å…³å˜é‡
        let live2dApp = null;
        let live2dModel = null;
        let currentExpression = 0;
        let isLive2DLoaded = false;

        // è¡¨æƒ…åˆ—è¡¨
        const expressions = [
            'bangbangtang.exp3.json',
            'changge.exp3.json',
            'dayouxi.exp3.json',
            'heilian.exp3.json',
            'heiyi.exp3.json',
            'ku.exp3.json',
            'lianhong.exp3.json',
            'quanquan.exp3.json',
            'shengqi.exp3.json',
            'shoubiao.exp3.json',
            'xingxing.exp3.json'
        ];

        // Live2Dæ—¥å¿—å‡½æ•°
        function live2dLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                [LIVE2D] ${message}
            `;

            document.getElementById('logs').appendChild(logEntry);
            document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
            console.log(`[LIVE2D-${type.toUpperCase()}] ${message}`);
        }

        // æ›´æ–°Live2DçŠ¶æ€
        function updateLive2DStatus(message, isActive = false) {
            const statusEl = document.getElementById('live2dStatus');
            const panelEl = document.getElementById('live2dPanel');

            statusEl.textContent = message;

            if (isActive) {
                panelEl.classList.add('active');
            } else {
                panelEl.classList.remove('active');
            }
        }

        // åŠ è½½Live2Dæ¨¡å‹
        async function loadLive2DModel() {
            try {
                updateLive2DStatus('Initializing Live2D system...', true);
                live2dLog('å¼€å§‹åŠ è½½Live2Dæ¨¡å‹', 'info');

                // æ£€æŸ¥PIXIæ˜¯å¦åŠ è½½
                if (typeof PIXI === 'undefined') {
                    throw new Error('PIXI.jsæœªåŠ è½½');
                }

                // åŠ¨æ€åŠ è½½pixi-live2d-display
                if (typeof PIXI.live2d === 'undefined') {
                    live2dLog('æ­£åœ¨åŠ è½½pixi-live2d-displayåº“...', 'info');

                    try {
                        // ä½¿ç”¨CDNåŠ è½½pixi-live2d-display
                        await loadScript('https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.5.0/dist/index.min.js');

                        if (typeof PIXI.live2d !== 'undefined') {
                            live2dLog('âœ… pixi-live2d-displayåŠ è½½æˆåŠŸ', 'success');
                        } else {
                            throw new Error('Live2Dåº“åŠ è½½å¤±è´¥');
                        }
                    } catch (error) {
                        live2dLog('âš ï¸ ä½¿ç”¨å¤‡ç”¨Live2Dæ–¹æ¡ˆ', 'info');
                        createFallbackLive2D();
                        return;
                    }
                }

                // åˆ›å»ºPIXIåº”ç”¨
                const container = document.getElementById('live2dCanvas');
                container.innerHTML = '';

                live2dApp = new PIXI.Application({
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    backgroundAlpha: 0,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                container.appendChild(live2dApp.view);
                live2dLog('PIXIåº”ç”¨åˆ›å»ºæˆåŠŸ', 'success');

                // åŠ è½½Live2Dæ¨¡å‹
                try {
                    updateLive2DStatus('Loading LANHEI model...', true);

                    const modelPath = '/static/lanhei/lanhei.model3.json';
                    live2dModel = await PIXI.live2d.Live2DModel.from(modelPath);

                    // è®¾ç½®æ¨¡å‹å±æ€§
                    live2dModel.scale.set(0.3);
                    live2dModel.position.set(container.offsetWidth / 2, container.offsetHeight - 50);
                    live2dModel.anchor.set(0.5, 0.9);

                    // æ·»åŠ åˆ°èˆå°
                    live2dApp.stage.addChild(live2dModel);

                    // æ’­æ”¾å¾…æœºåŠ¨ç”»
                    if (live2dModel.internalModel.motionManager) {
                        try {
                            await live2dModel.motion('/static/lanhei/Scene1.motion3.json');
                            live2dLog('å¾…æœºåŠ¨ç”»åŠ è½½æˆåŠŸ', 'success');
                        } catch (error) {
                            live2dLog('å¾…æœºåŠ¨ç”»åŠ è½½å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨æ¨¡å‹', 'info');
                        }
                    }

                    isLive2DLoaded = true;
                    updateLive2DStatus('LANHEI model ready - Click EXPR for expressions', false);
                    live2dLog('âœ… Live2Dæ¨¡å‹åŠ è½½å®Œæˆï¼', 'success');

                } catch (modelError) {
                    live2dLog(`æ¨¡å‹åŠ è½½å¤±è´¥: ${modelError.message}`, 'error');
                    updateLive2DStatus('Model load failed - Using fallback display', false);
                    createFallbackLive2D();
                }

            } catch (error) {
                live2dLog(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateLive2DStatus('Initialization failed', false);
                createFallbackLive2D();
            }
        }

        // åˆ›å»ºå¤‡ç”¨æ˜¾ç¤º
        function createFallbackLive2D() {
            const container = document.getElementById('live2dCanvas');
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #00ff88; font-family: 'Orbitron', monospace; text-align: center; flex-direction: column;">
                    <div style="font-size: 3rem; margin-bottom: 15px; animation: pulse 2s infinite;">ğŸ¤–</div>
                    <div style="font-size: 1.2rem; margin-bottom: 5px;">LANHEI</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Digital Assistant</div>
                    <div style="font-size: 0.7rem; opacity: 0.6; margin-top: 10px;">[Fallback Mode]</div>
                </div>
            `;
            updateLive2DStatus('Fallback mode active', false);
            live2dLog('ä½¿ç”¨å¤‡ç”¨æ˜¾ç¤ºæ¨¡å¼', 'info');
        }

        // é‡ç½®Live2Dæ¨¡å‹
        function resetLive2DModel() {
            if (live2dApp) {
                live2dApp.destroy(true);
                live2dApp = null;
                live2dModel = null;
                isLive2DLoaded = false;
            }

            const container = document.getElementById('live2dCanvas');
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #00ff88; font-family: 'Orbitron', monospace; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ­</div>
                        <div>LANHEI MODEL</div>
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 5px;">Click LOAD to initialize</div>
                    </div>
                </div>
            `;

            updateLive2DStatus('Model reset - Ready for reload', false);
            live2dLog('Live2Dæ¨¡å‹å·²é‡ç½®', 'info');
        }

        // åˆ‡æ¢è¡¨æƒ…
        function toggleExpression() {
            if (!isLive2DLoaded || !live2dModel) {
                live2dLog('è¯·å…ˆåŠ è½½Live2Dæ¨¡å‹', 'error');
                return;
            }

            try {
                const expressionFile = expressions[currentExpression];

                // å°è¯•åŠ è½½è¡¨æƒ…
                if (live2dModel.internalModel.expressionManager) {
                    live2dModel.expression(`/static/lanhei/${expressionFile}`);
                    live2dLog(`åˆ‡æ¢è¡¨æƒ…: ${expressionFile}`, 'success');
                } else {
                    live2dLog('è¡¨æƒ…ç³»ç»Ÿä¸å¯ç”¨', 'warning');
                }

                currentExpression = (currentExpression + 1) % expressions.length;
                updateLive2DStatus(`Expression: ${expressionFile.replace('.exp3.json', '')}`, true);

                // 2ç§’åæ¢å¤çŠ¶æ€æ˜¾ç¤º
                setTimeout(() => {
                    updateLive2DStatus('LANHEI model ready - Click EXPR for expressions', false);
                }, 2000);

            } catch (error) {
                live2dLog(`è¡¨æƒ…åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ç²’å­ç³»ç»Ÿç±»
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.mouse = { x: -1000, y: -1000 }; // åˆå§‹é¼ æ ‡ä½ç½®è¿œç¦»å±å¹•
                this.targetPositions = [];
                this.isInitialized = false;

                this.init();
                this.bindEvents();
                this.animate();
            }

            init() {
                this.resizeCanvas();
                this.createLetterE();
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                    this.createLetterE(); // é‡æ–°åˆ›å»ºå­—æ¯Eçš„ä½ç½®
                });
            }

            resizeCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createLetterE() {
                // å®šä¹‰è‰ºæœ¯ä½“åœ†å½¢Eçš„å½¢çŠ¶ç‚¹ä½ - æ”¾åœ¨å³ä¸‹è§’ä¸audioå¯¹é½ï¼Œæ•´ä½“å·¦ç§»æ›´å¤š
                const audioPanelX = 50; // å·¦ä¾§éŸ³é¢‘é¢æ¿ä½ç½®
                const centerX = this.canvas.width - 280; // Eå­—çš„ä¸­å¿ƒXä½ç½®ï¼Œå†å·¦ç§»80px
                const centerY = this.canvas.height - 150; // è·ç¦»åº•éƒ¨150px
                const radius = 120; // è¿›ä¸€æ­¥å¢å¤§åœ†å½¢Eçš„åŠå¾„

                this.targetPositions = [];

                // è‰ºæœ¯ä½“åœ†å½¢Eçš„ç»“æ„ï¼šæœ‰å¼€å£çš„åœ†ç¯ + ä¸­é—´æ°´å¹³çº¿
                const spacing = 9; // æå¤§é—´è·ï¼Œè®©ç²’å­éå¸¸ç¨€ç–
                const strokeWidth = 3; // æœ€å°‘ç¬”ç”»å®½åº¦

                // 1. åˆ›å»ºæœ‰å¼€å£çš„åœ†å½¢å¤–ç¯ï¼ˆå³ä¾§å¼€å£ï¼‰
                const outerRadius = radius;
                const innerRadius = radius - strokeWidth * spacing;

                // ç»˜åˆ¶æœ‰å¼€å£çš„åœ†ç¯ï¼Œä¸Šä¸‹éƒ½ç•¥å¾®å»¶é•¿
                // ä»45åº¦ç»˜åˆ¶åˆ°315åº¦ï¼Œä¸Šä¸‹éƒ½ç¨å¾®å»¶é•¿
                for (let angle = Math.PI * 0.25; angle <= Math.PI * 1.75; angle += 0.08) {

                    // å¤–åœ†å¼§çš„å¤šå±‚ç²’å­
                    for (let r = innerRadius; r <= outerRadius; r += spacing) {
                        const x = centerX + Math.cos(angle) * r;
                        const y = centerY + Math.sin(angle) * r;
                        this.targetPositions.push({ x, y });
                    }
                }

                // 2. åˆ›å»ºä¸­é—´çš„æ°´å¹³çº¿ï¼ˆä»å·¦è¾¹ç•Œåˆ°å³ä¾§å¼€å£ï¼‰
                const lineY = centerY;
                const lineStartX = centerX - outerRadius + spacing;
                const lineEndX = centerX + innerRadius - spacing; // åªå»¶ä¼¸åˆ°å†…åœ†ï¼Œä¸å°é—­å¼€å£

                for (let x = lineStartX; x <= lineEndX; x += spacing) {
                    for (let t = -1; t <= 1; t++) {
                        this.targetPositions.push({
                            x: x,
                            y: lineY + t * spacing * 0.6 // è¿›ä¸€æ­¥å‡å°‘å‚ç›´é—´è·ï¼Œè®©çº¿æ¡æ›´ç»†
                        });
                    }
                }

                // åˆ›å»ºç²’å­ - ä»æ•´ä¸ªå±å¹•éšæœºä½ç½®å¼€å§‹ï¼Œå®ç°ç¼“æ…¢èšé›†æ•ˆæœ
                this.particles = [];
                this.targetPositions.forEach((pos, index) => {
                    const particle = new Particle(
                        Math.random() * this.canvas.width,   // ä»æ•´ä¸ªå±å¹•å®½åº¦éšæœºå¼€å§‹
                        Math.random() * this.canvas.height,  // ä»æ•´ä¸ªå±å¹•é«˜åº¦éšæœºå¼€å§‹
                        pos.x,
                        pos.y,
                        index
                    );
                    this.particles.push(particle);
                });

                this.isInitialized = true;
                console.log(`åˆ›å»ºäº† ${this.particles.length} ä¸ªæå°æç¨€ç–çš„çº¯ç™½è‰²ç²’å­ï¼Œå°†è¶…çº§ç¼“æ…¢èšé›†æˆå³ä¾§å•å¼€å£ã€ä¸Šä¸‹ç•¥å¾®å»¶é•¿çš„åœ†å½¢è‰ºæœ¯ä½“Eå­—å½¢çŠ¶åœ¨è¿›ä¸€æ­¥å·¦ç§»çš„ä½ç½®ä¸audioå¯¹é½ (${centerX}, ${centerY})`);
            }

            bindEvents() {
                document.addEventListener('mousemove', (e) => {
                    this.mouse.x = e.clientX;
                    this.mouse.y = e.clientY;
                });

                // é¼ æ ‡ç¦»å¼€é¡µé¢æ—¶é‡ç½®ä½ç½®
                document.addEventListener('mouseleave', () => {
                    this.mouse.x = -1000;
                    this.mouse.y = -1000;
                });
            }

            animate() {
                // æ¸…é™¤ç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (this.isInitialized && this.particles.length > 0) {
                    // ç»˜åˆ¶ç²’å­
                    this.particles.forEach(particle => {
                        particle.update(this.mouse);
                        particle.draw(this.ctx);
                    });

                    // ç»˜åˆ¶è¿æ¥çº¿å¢å¼ºæ•ˆæœ
                    this.drawConnections();
                }

                requestAnimationFrame(() => this.animate());
            }

            drawConnections() {
                // ç§»é™¤è¿æ¥çº¿æ•ˆæœï¼Œè®©Eå­—æ›´ç®€æ´è‰ºæœ¯
                return;
            }
        }

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, targetX, targetY, index) {
                this.x = x;
                this.y = y;
                this.targetX = targetX + (Math.random() - 0.5) * 3; // é€‚å½“çš„éšæœºåç§»è®©è‰ºæœ¯ä½“æ›´è‡ªç„¶
                this.targetY = targetY + (Math.random() - 0.5) * 3;
                this.vx = 0;
                this.vy = 0;
                this.index = index;
                this.size = 1.8; // æå°çš„ç²’å­
                this.opacity = 0.08; // ç¨é«˜çš„åˆå§‹é€æ˜åº¦ï¼Œæ›´æ¸…æ™°
                this.maxOpacity = 0.95;
                this.baseOpacity = 0.9;

                // çº¯ç™½è‰²ç²’å­
                this.color = { r: 255, g: 255, b: 255 };

                // ç§»é™¤è„‰åŠ¨æ•ˆæœ
                this.hasReachedTarget = false; // ç”¨äºè·Ÿè¸ªæ˜¯å¦åˆ°è¾¾ç›®æ ‡
            }

            update(mouse) {
                // è®¡ç®—åˆ°ç›®æ ‡ä½ç½®çš„è·ç¦»
                const dx = this.targetX - this.x;
                const dy = this.targetY - this.y;
                const targetDistance = Math.sqrt(dx ** 2 + dy ** 2);

                // è®¡ç®—åˆ°é¼ æ ‡çš„è·ç¦»
                const mouseDistance = Math.sqrt(
                    (mouse.x - this.x) ** 2 + (mouse.y - this.y) ** 2
                );

                // é¼ æ ‡æ’æ–¥æ•ˆæœ - å¢å¤§èŒƒå›´å’Œå¼ºåº¦
                const repelRadius = 100;
                let repelForceX = 0;
                let repelForceY = 0;

                if (mouseDistance < repelRadius && mouseDistance > 0) {
                    const repelStrength = Math.pow((repelRadius - mouseDistance) / repelRadius, 2);
                    const angle = Math.atan2(this.y - mouse.y, this.x - mouse.x);
                    repelForceX = Math.cos(angle) * repelStrength * 7; // è¿›ä¸€æ­¥å¢å¼ºæ•£å¼€åŠ›åº¦ï¼Œæ¯”è¿˜åŸæ›´å¿«
                    repelForceY = Math.sin(angle) * repelStrength * 7;
                }

                // ç¼“æ…¢çš„å‘ç›®æ ‡ä½ç½®ç§»åŠ¨ - è¶…çº§ç¼“æ…¢çš„è¿˜åŸ
                let attractStrength = 0.003; // è¶…çº§æå°çš„å¼•åŠ›ï¼Œè®©èšé›†è¶…çº§ç¼“æ…¢

                // è·ç¦»è¶Šè¿œï¼Œå¼•åŠ›ç¨å¾®å¢å¼º
                if (targetDistance > 450) {
                    attractStrength = 0.008;
                } else if (targetDistance > 250) {
                    attractStrength = 0.005;
                }

                const attractForceX = dx * attractStrength;
                const attractForceY = dy * attractStrength;

                // åˆæˆåŠ›
                this.vx += attractForceX + repelForceX;
                this.vy += attractForceY + repelForceY;

                // å¢åŠ é˜»å°¼è®©è¿åŠ¨æ›´ç¼“æ…¢å¹³ç¨³
                this.vx *= 0.9;
                this.vy *= 0.9;

                // é™åˆ¶æœ€å¤§é€Ÿåº¦ - å…è®¸æ•£å¼€æ—¶éå¸¸å¿«çš„é€Ÿåº¦
                const maxSpeed = 8;
                const currentSpeed = Math.sqrt(this.vx ** 2 + this.vy ** 2);
                if (currentSpeed > maxSpeed) {
                    this.vx = (this.vx / currentSpeed) * maxSpeed;
                    this.vy = (this.vy / currentSpeed) * maxSpeed;
                }

                // æ›´æ–°ä½ç½®
                this.x += this.vx;
                this.y += this.vy;

                // æ£€æŸ¥æ˜¯å¦æ¥è¿‘ç›®æ ‡ä½ç½®
                if (targetDistance < 15) {
                    this.hasReachedTarget = true;
                }

                // ç®€åŒ–çš„é€æ˜åº¦åŠ¨ç”» - ç¼“æ…¢å¢åŠ é€æ˜åº¦
                let targetOpacity;

                if (targetDistance < 10) {
                    // éå¸¸æ¥è¿‘ç›®æ ‡æ—¶è¾¾åˆ°æœ€å¤§é€æ˜åº¦
                    targetOpacity = this.maxOpacity;
                    this.hasReachedTarget = true;
                } else if (targetDistance < 30) {
                    // æ¥è¿‘ç›®æ ‡æ—¶é€æ¸å˜äº®
                    targetOpacity = this.baseOpacity * (1 - targetDistance / 60);
                } else if (targetDistance < 100) {
                    // ä¸­ç­‰è·ç¦»æ—¶ä¿æŒä¸­ç­‰é€æ˜åº¦
                    targetOpacity = 0.5;
                } else {
                    // è¿œç¦»ç›®æ ‡æ—¶ä¿æŒè¾ƒä½é€æ˜åº¦
                    targetOpacity = 0.3;
                }

                // é¼ æ ‡é™„è¿‘é€æ˜åº¦å˜åŒ– - æ›´å¼ºçš„é€æ˜åº¦å˜åŒ–
                if (mouseDistance < repelRadius) {
                    const fadeStrength = 1 - (mouseDistance / repelRadius);
                    targetOpacity *= (1 - fadeStrength * 0.8); // å¢å¼ºé€æ˜åº¦å˜åŒ–æ•ˆæœ
                }

                // é€‚ä¸­çš„é€æ˜åº¦è¿‡æ¸¡
                const opacitySpeed = 0.012; // é€‚åº¦æé«˜é€æ˜åº¦å˜åŒ–é€Ÿåº¦ï¼Œå¢å¼ºæ¸…æ™°åº¦
                if (this.opacity < targetOpacity) {
                    this.opacity = Math.min(targetOpacity, this.opacity + opacitySpeed);
                } else {
                    this.opacity = Math.max(targetOpacity, this.opacity - opacitySpeed);
                }

                // ç¡®ä¿é€æ˜åº¦èŒƒå›´
                this.opacity = Math.max(0.1, Math.min(1, this.opacity));
            }

            draw(ctx) {
                if (this.opacity <= 0.05) return;

                ctx.save();

                // ç»˜åˆ¶é«˜æ¸…æ™°åº¦çš„ç™½è‰²åœ†ç‚¹
                const alpha = Math.min(1, this.opacity);

                // ä¸»ä½“å¡«å……
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();

                // é«˜æ¸…æ™°åº¦è¾¹æ¡†ï¼ˆé€‚é…æå°ç²’å­ï¼‰
                ctx.strokeStyle = `rgba(255, 255, 255, ${Math.min(1, alpha + 0.2)})`;
                ctx.lineWidth = 0.4;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.stroke();

                // å†…éƒ¨é«˜äº®ç‚¹å¢å¼ºæ¸…æ™°åº¦
                if (alpha > 0.4) {
                    ctx.fillStyle = `rgba(255, 255, 255, ${Math.min(1, alpha * 1.2)})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        class EvercallTTS {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.isProcessing = false;
                this.audioChunks = [];
                this.chunkCount = 0;
                this.totalSize = 0;
                this.audioCache = [];
                this.currentPlayingIndex = -1;

                this.statusEl = document.getElementById('status');
                this.textInput = document.getElementById('textInput');
                this.synthesizeBtn = document.getElementById('synthesizeBtn');
                this.progressInfo = document.getElementById('progressInfo');
                this.synthStatus = document.getElementById('synthStatus');
                this.chunkCountEl = document.getElementById('chunkCount');
                this.audioSizeEl = document.getElementById('audioSize');
                this.audioPlayer = document.getElementById('audioPlayer');
                this.logsEl = document.getElementById('logs');
                this.audioCacheEl = document.getElementById('audioCache');
                this.cacheListEl = document.getElementById('cacheList');

                this.init();
            }

            init() {
                this.connect();
                this.bindEvents();
                this.bindKeyboardEvents();
            }

            connect() {
                try {
                    const wsUrl = "{{ websocket_url }}";
                    this.log(`Establishing connection: ${wsUrl}`, 'info');

                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateStatus('connected', 'System Online');
                        this.log('WebSocket connection established', 'success');
                        this.synthesizeBtn.disabled = false;
                    };

                    this.ws.onmessage = (event) => {
                        this.handleMessage(JSON.parse(event.data));
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateStatus('disconnected', 'Connection Lost');
                        this.log('WebSocket connection terminated', 'error');
                        this.synthesizeBtn.disabled = true;

                        setTimeout(() => this.connect(), 3000);
                    };

                    this.ws.onerror = (error) => {
                        this.log(`Connection error: ${error}`, 'error');
                    };

                } catch (error) {
                    this.log(`Failed to establish connection: ${error}`, 'error');
                }
            }

            bindEvents() {
                this.synthesizeBtn.addEventListener('click', () => {
                    if (this.isConnected && !this.isProcessing) {
                        this.startSynthesis();
                    }
                });

                this.textInput.addEventListener('input', (e) => {
                    const remaining = 5000 - e.target.value.length;
                    if (remaining < 0) {
                        e.target.value = e.target.value.substring(0, 5000);
                    }
                });
            }

            bindKeyboardEvents() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                        return;
                    }

                    const key = e.key;
                    let index = -1;

                    if (key >= '1' && key <= '9') {
                        index = parseInt(key) - 1;
                    }
                    else if (key === '0') {
                        index = 9;
                    }

                    if (index >= 0 && index < this.audioCache.length) {
                        e.preventDefault();
                        this.playFromCache(index);
                    }
                });
            }

            startSynthesis() {
                const text = this.textInput.value.trim();
                if (!text) {
                    this.log('No input text detected', 'error');
                    return;
                }

                this.isProcessing = true;
                this.audioChunks = [];
                this.chunkCount = 0;
                this.totalSize = 0;

                this.updateStatus('processing', 'Processing Request');
                this.synthesizeBtn.disabled = true;
                this.progressInfo.style.display = 'block';
                this.synthStatus.textContent = 'Initializing...';
                this.audioPlayer.style.display = 'none';

                document.body.classList.add('processing');

                this.ws.send(JSON.stringify({
                    type: 'tts_request',
                    text: text
                }));

                this.log(`Synthesis initiated: ${text.substring(0, 50)}...`, 'info');
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'welcome':
                        this.log(data.message, 'success');
                        break;

                    case 'tts_start':
                        this.log(data.message, 'info');
                        this.synthStatus.textContent = 'Generating Audio...';
                        break;

                    case 'audio_chunk':
                        this.chunkCount++;
                        this.totalSize += data.chunk_size;

                        const audioData = this.hexToUint8Array(data.audio_data);
                        this.audioChunks.push(audioData);

                        this.chunkCountEl.textContent = this.chunkCount;
                        this.audioSizeEl.textContent = this.formatBytes(this.totalSize);
                        this.synthStatus.textContent = `Receiving data... (${this.chunkCount} chunks)`;

                        this.log(`Audio chunk #${data.chunk_id}: ${this.formatBytes(data.chunk_size)}`, 'success');
                        break;

                    case 'tts_complete':
                        this.isProcessing = false;
                        this.synthesizeBtn.disabled = false;
                        this.updateStatus('connected', 'Synthesis Complete');
                        this.synthStatus.textContent = 'Audio Ready';

                        document.body.classList.remove('processing');

                        this.log(data.message, 'success');
                        this.log(`Total audio size: ${this.formatBytes(data.total_size)}`, 'info');

                        this.createAndPlayAudio(data.total_audio, this.textInput.value.trim());
                        break;

                    case 'error':
                        this.isProcessing = false;
                        this.synthesizeBtn.disabled = false;
                        this.updateStatus('disconnected', 'Error Occurred');
                        this.synthStatus.textContent = 'Process Failed';

                        document.body.classList.remove('processing');

                        this.log(`Error: ${data.message}`, 'error');
                        break;

                    case 'pong':
                        break;

                    default:
                        this.log(`Unknown message type: ${data.type}`, 'error');
                }
            }

            createAndPlayAudio(hexAudioData, text = '') {
                try {
                    const audioData = this.hexToUint8Array(hexAudioData);
                    const audioBlob = new Blob([audioData], { type: 'audio/mp3' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    this.addToCache(text, audioUrl, audioData.length);

                    this.audioPlayer.src = audioUrl;
                    this.audioPlayer.style.display = 'block';

                    this.audioPlayer.play().then(() => {
                        this.log('Audio playback initiated', 'success');
                        this.currentPlayingIndex = this.audioCache.length - 1;
                        this.updateCacheDisplay();
                    }).catch((error) => {
                        this.log(`Playback failed: ${error}`, 'error');
                    });

                    this.audioPlayer.addEventListener('ended', () => {
                        this.log('Audio playback completed', 'info');
                        this.currentPlayingIndex = -1;
                        this.updateCacheDisplay();
                    }, { once: true });

                } catch (error) {
                    this.log(`Audio creation failed: ${error}`, 'error');
                }
            }

            addToCache(text, audioUrl, size) {
                const cacheItem = {
                    text: text,
                    url: audioUrl,
                    size: size,
                    timestamp: new Date().toLocaleTimeString()
                };

                this.audioCache.unshift(cacheItem);

                if (this.audioCache.length > 10) {
                    const oldItem = this.audioCache.pop();
                    URL.revokeObjectURL(oldItem.url);
                }

                this.updateCacheDisplay();
                this.log(`Audio cached: ${this.audioCache.length}/10 entries`, 'info');
            }

            updateCacheDisplay() {
                if (this.audioCache.length === 0) {
                    this.audioCacheEl.style.display = 'none';
                    return;
                }

                this.audioCacheEl.style.display = 'block';
                this.cacheListEl.innerHTML = '';

                this.audioCache.forEach((item, index) => {
                    const cacheItem = document.createElement('div');
                    cacheItem.className = 'cache-item';
                    if (index === this.currentPlayingIndex) {
                        cacheItem.classList.add('playing');
                    }

                    const keyNumber = index === 9 ? '0' : (index + 1).toString();

                    cacheItem.innerHTML = `
                        <div class="cache-text">${item.text || 'Unknown Text'}</div>
                        <div class="cache-info">
                            <div>
                                <span class="cache-key">${keyNumber}</span>
                                <span class="cache-meta">${item.timestamp} | ${this.formatBytes(item.size)}</span>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation();" data-index="${index}">DEL</button>
                        </div>
                    `;

                    cacheItem.addEventListener('click', (e) => {
                        if (e.target.classList.contains('delete-btn')) {
                            return;
                        }
                        this.playFromCache(index);
                    });

                    const deleteBtn = cacheItem.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deleteFromCache(index);
                    });

                    this.cacheListEl.appendChild(cacheItem);
                });
            }

            playFromCache(index) {
                if (index < 0 || index >= this.audioCache.length) {
                    return;
                }

                const cacheItem = this.audioCache[index];
                this.audioPlayer.src = cacheItem.url;
                this.audioPlayer.style.display = 'block';

                this.audioPlayer.play().then(() => {
                    this.currentPlayingIndex = index;
                    this.updateCacheDisplay();
                    this.log(`Playing cached audio ${index + 1}: ${cacheItem.text.substring(0, 30)}...`, 'success');
                }).catch((error) => {
                    this.log(`Cached playback failed: ${error}`, 'error');
                });

                this.audioPlayer.addEventListener('ended', () => {
                    this.currentPlayingIndex = -1;
                    this.updateCacheDisplay();
                }, { once: true });
            }

            deleteFromCache(index) {
                if (index < 0 || index >= this.audioCache.length) {
                    return;
                }

                const deletedItem = this.audioCache[index];

                if (this.currentPlayingIndex === index) {
                    this.audioPlayer.pause();
                    this.currentPlayingIndex = -1;
                }
                else if (this.currentPlayingIndex > index) {
                    this.currentPlayingIndex--;
                }

                URL.revokeObjectURL(deletedItem.url);
                this.audioCache.splice(index, 1);
                this.updateCacheDisplay();

                this.log(`Cache entry deleted: ${deletedItem.text.substring(0, 20)}... | Remaining: ${this.audioCache.length}/10`, 'info');
            }

            hexToUint8Array(hexString) {
                const bytes = new Uint8Array(hexString.length / 2);
                for (let i = 0; i < hexString.length; i += 2) {
                    bytes[i / 2] = parseInt(hexString.substr(i, 2), 16);
                }
                return bytes;
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            updateStatus(type, message) {
                this.statusEl.className = `status ${type}`;
                this.statusEl.textContent = message;
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${level}`;
                logEntry.innerHTML = `
                    <span class="log-timestamp">[${timestamp}]</span>
                    ${message}
                `;

                this.logsEl.appendChild(logEntry);
                this.logsEl.scrollTop = this.logsEl.scrollHeight;
            }

            startHeartbeat() {
                setInterval(() => {
                    if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                        this.ws.send(JSON.stringify({
                            type: 'ping',
                            timestamp: Date.now()
                        }));
                    }
                }, 30000);
            }
        }

        // å…¨å±€å‡½æ•°ç”¨äºæŒ‰é’®ç‚¹å‡» (å¤‡ç”¨)
        function changeExpression(expression) {
            // ä½¿ç”¨æ–°çš„Live2Dç³»ç»Ÿ
            toggleExpression();
        }

        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–ç²’å­ç³»ç»Ÿ
            const canvas = document.getElementById('particleCanvas');
            const particleSystem = new ParticleSystem(canvas);

            // åˆå§‹åŒ–TTSå®¢æˆ·ç«¯
            const client = new EvercallTTS();
            client.startHeartbeat();
        });
    </script>
</body>
</html>
